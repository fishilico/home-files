# Configuration file for https://circleci.com/

# In order not to use a broken python3 program which only displays:
#   pyenv: python3: command not found
#   The `python3' command exists in these Python versions:
#      ...
# configure $PATH in the project environment variables to:
#   /home/ubuntu/bin:/usr/sbin:/usr/bin:/sbin:/bin

dependencies:
  cache_directories:
    - "~/.cabal"
  pre:
    - sudo apt-get update -qq
    - sudo apt-get install -qq ash busybox pep8 zsh

    # Install shellcheck, using cabal cache
    - test -x "$HOME/.cabal/bin/shellcheck" || (PATH="/opt/ghc/bin:$PATH" ; cabal update && cabal install shellcheck)
    - ln -s "$HOME/.cabal/bin/shellcheck" "$HOME/bin/shellcheck"
    - shellcheck --version

    # Fix crontab group (it is sgid with syslog instead of crontab group)
    - ls -l /usr/bin/crontab && sudo chgrp crontab /usr/bin/crontab && sudo chmod -c g+s /usr/bin/crontab

test:
  override:
    # Run automated tests
    - ./run_tests.sh
    # Install the files after removing conflicting local files
    - rm -f ~/.bash_profile ~/.bash_logout ~/.bashrc ~/.gitconfig ~/.gnupg/gpg.conf ~/.profile ~/.zshrc
    - ./install.sh
    # Test updating branch master of the project
    - git remote set-branches origin master
    - git fetch origin
    - ./update.sh
    # Finish with a dump of the configuration
    - bin/config-summary
