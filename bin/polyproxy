#!/bin/sh
#
# Copyright (c) 2013-2017 Nicolas Iooss
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
#
# Ecole polytechnique proxy configuration
# Use this file with "source"
# Student config:
#     DNS 129.104.201.53, 129.104.201.51
#     proxy 129.104.247.2 (kuzh.polytechnique.fr)
# Non-student config:
#     DNS 129.104.30.41, 129.104.7.41
#     proxy 129.104.38.5 (garvleiz.polytechnique.fr)

export HTTP_PROXY_HOST="${HTTP_PROXY_HOST:-129.104.247.2}"
export HTTP_PROXY_PORT="${HTTP_PROXY_PORT:-8080}"
export HTTP_PROXY_PAC="${HTTP_PROXY_PAC:-http://config.eleves.polytechnique.fr/proxy.pac}"

export all_proxy="http://$HTTP_PROXY_HOST:$HTTP_PROXY_PORT/"
export http_proxy="http://$HTTP_PROXY_HOST:$HTTP_PROXY_PORT/"
export https_proxy="http://$HTTP_PROXY_HOST:$HTTP_PROXY_PORT/"
export ftp_proxy="http://$HTTP_PROXY_HOST:$HTTP_PROXY_PORT/"
export no_proxy='.polytechnique.fr,.eleves.polytechnique.fr'

export RSYNC_PROXY="$HTTP_PROXY_HOST:$HTTP_PROXY_PORT"

# Use socat, connect (Debian) or connect-procy (Ubuntu) for ssh
export SSH_PROXYCOMMAND=""
if which socat > /dev/null 2>&1
then
    SSH_PROXYCOMMAND="socat - PROXY:$HTTP_PROXY_HOST:%h:%p,proxyport=$HTTP_PROXY_PORT"
elif which connect > /dev/null 2>&1
then
    SSH_PROXYCOMMAND="connect -H $HTTP_PROXY_HOST:$HTTP_PROXY_PORT %h %p"
elif which connect-proxy > /dev/null 2>&1
then
    SSH_PROXYCOMMAND="connect-proxy -H $HTTP_PROXY_HOST:$HTTP_PROXY_PORT %h %p"
fi
# shellcheck disable=SC2039
if type alias > /dev/null 2>&1 && [ -n "$SSH_PROXYCOMMAND" ]
then
    # shellcheck disable=SC2139
    alias sshExt="ssh -o ProxyCommand='$SSH_PROXYCOMMAND'"

    # rsync over ssh doesn't use $RSYNC_PROXY
    # shellcheck disable=SC2139
    alias rsyncSshExt="rsync -e \"ssh -o ProxyCommand='$SSH_PROXYCOMMAND'\""

    # If scp is an alias to rsync, give parameters to rsync
    if alias scp 2> /dev/null | grep -q 'rsync'
    then
        # shellcheck disable=SC2139
        alias scpExt="scp -e \"ssh -o ProxyCommand='$SSH_PROXYCOMMAND'\""
    else
        # shellcheck disable=SC2139
        alias scpExt="scp -o ProxyCommand='$SSH_PROXYCOMMAND'"
    fi

    # Chromium with proxy autoconfiguration
    # shellcheck disable=SC2139
    alias chromium-xpac="chromium --proxy-pac-url=$HTTP_PROXY_PAC"
    # shellcheck disable=SC2139
    alias chromium-xpro="chromium --proxy-server=$HTTP_PROXY_HOST:$HTTP_PROXY_PORT"
fi

# Non-proxied addresses (useful when configuring routes):
#     129.104.30.0/24 (DMZ)
#     129.104.38.10/32 (helixium.polytechnique.fr video streaming)
#     129.104.192.0/18 (=/255.255.192.0)

# Add all routes by specifing a gateway
xroutes_add_via() {
    ip -4 route add 129.104.30.0/24 via "$1"
    ip -4 route add 129.104.38.10/32 via "$1"
    ip -4 route add 129.104.192.0/18 via "$1"
    echo "Added routes to X via $1"
}
# Add all routes with current gateway
xroutes_add() {
    local GW
    GW=$(ip -4 route get 129.104.255.255 |sed -n '1s/^.*via\s\+\([0-9.]\+\).*$/\1/p')
    xroutes_add_via "$GW"
}
xroutes_del() {
    ip -4 route del 129.104.30.0/24
    ip -4 route del 129.104.38.10/32
    ip -4 route del 129.104.192.0/18
    echo "Deleted routes to X"
}
