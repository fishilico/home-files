#!/bin/sh
# SPDX-License-Identifier: MIT
#
# Copyright (c) 2014-2024 Nicolas Iooss
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
#
# This script has been written based on what can be found on
# https://wiki.archlinux.org/title/Pacman/Tips_and_tricks

tmp="$(mktemp -d "${TMPDIR-/tmp}/pacman-disowned-XXXXXX")"
trap 'rm -rf "$tmp"' EXIT

pacman -Qlq | sort -u > "$tmp/db"

find /bin /etc /sbin /lib /usr \
  ! -name lost+found \
  \( -type d -printf '%p/\n' -o -print \) | sort > "$tmp/fs"

# Remove known autogenerated files
sed -i "$tmp/fs" \
    -e '/~$/d' \
    -e '/^\/etc\/\(group\|gshadow\|passwd\|shadow\)-$/d' \
    -e '/^\/etc\/adjtime$/d' \
    -e '/^\/etc\/brlapi\.key$/d' \
    -e '/^\/etc\/conf\.d\/lm_sensors$/d' \
    -e '/^\/etc\/dconf\/\($\|db\/\)/d' \
    -e '/^\/etc\/gtk-2\.0\/gdk-pixbuf\.loaders$/d' \
    -e '/^\/etc\/hostname$/d' \
    -e '/^\/etc\/iptables\//d' \
    -e '/^\/etc\/ld\.so\.cache$/d' \
    -e '/^\/etc\/locale\.conf$/d' \
    -e '/^\/etc\/localtime$/d' \
    -e '/^\/etc\/machine-id$/d' \
    -e '/^\/etc\/NetworkManager\/system-connections\//d' \
    -e '/^\/etc\/openvpn\//d' \
    -e '/^\/etc\/pacman\.d\/gnupg\//d' \
    -e '/^\/etc\/pango\/pango\.modules\(-32\)\?$/d' \
    -e '/^\/etc\/postfix\/.*\.db$/d' \
    -e '/^\/etc\/\.pwd\.lock$/d' \
    -e '/^\/etc\/rndc\.key$/d' \
    -e '/^\/etc\/ssh\/ssh_host_[a-z]\+\(_key\)\?\(\.pub\)\?$/d' \
    -e '/^\/etc\/ssl\/certs\//d' \
    -e '/^\/etc\/systemd\/system\//d' \
    -e '/^\/etc\/texmf\/ls-R$/d' \
    -e '/^\/etc\/udev\/hwdb\.bin$/d' \
    -e '/^\/etc\/vconsole\.conf$/d' \
    -e '/^\/usr\/share\/icons\/[a-z]\+\/icon-theme\.cache$/d' \
    -e '/^\/usr\/share\/mime\//d' \
    -e '/^\/usr\/share\/texmf\(-dist\)\?\/ls-R$/d'

# Show only lines in fs and not db
comm -23 "$tmp/fs" "$tmp/db"
